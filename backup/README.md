### PostgreSQL 数据库备份脚本使用文档

#### 1. 脚本简介
本脚本用于备份 PostgreSQL 数据库。它会连接到指定的 PostgreSQL 主机，获取所有非模板数据库，并将它们导出为备份文件。备份文件将被保存在指定的目录中。如果没有指定备份目录，默认将备份文件保存在脚本执行的当前目录。

#### 2. 使用说明

##### 2.1. 脚本调用格式
```bash
./backup_pg.sh <PGUSER> <PGHOST> [BACKUP_DIR]
```

- **PGUSER**：PostgreSQL 用户名，用于连接数据库。
- **PGHOST**：PostgreSQL 主机地址，通常是 IP 地址或主机名。
- **BACKUP_DIR**：可选参数，指定备份文件存储的目录。如果不提供此参数，脚本将使用当前目录作为备份目录。

##### 2.2. 示例

1. **指定备份目录的情况**
   ```bash
   ./backup_pg.sh postgres 127.0.0.1 /path/to/backup/
   ```
   该命令将使用用户名 `postgres` 连接到主机 `127.0.0.1`，并将数据库备份存储在 `/path/to/backup/` 目录下。

2. **使用当前目录作为备份目录**
   ```bash
   ./backup_pg.sh postgres 127.0.0.1
   ```
   如果不提供备份目录，脚本将使用当前目录（即运行脚本时所在的目录）存储备份文件。

#### 3. 脚本功能

- **连接到 PostgreSQL 数据库**：脚本会根据传入的 `PGUSER` 和 `PGHOST` 参数，使用 `psql` 命令连接到 PostgreSQL 数据库。
- **获取非模板数据库**：脚本会列出所有非模板数据库，并进行备份。模板数据库如 `template0` 和 `template1` 会被自动排除。
- **备份每个数据库**：使用 `pg_dump` 命令对每个数据库进行备份，备份文件格式为 `custom`（即 `.backup` 格式），支持二进制备份。
- **备份文件命名**：每个备份文件的文件名将以数据库名称命名，后缀为 `.backup`。例如，备份名为 `mydatabase.backup`。

#### 4. 脚本详细功能

- **检查输入参数**：脚本会检查是否提供了 PostgreSQL 用户名（`PGUSER`）和主机地址（`PGHOST`）。如果缺少这些参数，脚本会提示正确的使用方法并退出。
- **默认使用当前目录**：如果没有指定备份目录，脚本将默认使用当前工作目录作为备份目录。
- **备份每个数据库**：脚本会循环遍历每个非模板数据库，并使用 `pg_dump` 命令将其备份到指定目录。如果备份成功，脚本会输出成功信息；否则，输出错误信息。

#### 5. 错误处理

- 如果脚本执行过程中遇到任何错误，`pg_dump` 会返回非零退出码，脚本会打印错误信息并跳过该数据库的备份。
- 如果所有数据库的备份成功完成，脚本会打印 `"Backup completed."`。

#### 6. 脚本示例

假设你希望备份主机 `192.168.1.100` 上的 PostgreSQL 数据库，并将备份文件存储在 `/backups/` 目录下：

```bash
./backup_pg.sh postgres 192.168.1.100 /backups/
```

如果没有指定备份目录，则会使用当前目录：

```bash
./backup_pg.sh postgres 192.168.1.100
```

#### 7. 注意事项

- **权限要求**：确保 `PGUSER` 用户有足够的权限来访问和备份数据库。可以使用 `pg_hba.conf` 配置文件来配置允许连接的用户和主机。
- **磁盘空间**：备份文件可能会占用大量磁盘空间，请确保目标目录有足够的空间存储备份文件。
- **pg_dump 安装**：脚本依赖于 `pg_dump` 工具，请确保目标系统已安装 PostgreSQL 客户端工具。

---

通过本脚本，你可以轻松地备份 PostgreSQL 数据库，并将备份文件保存在指定目录，帮助你进行定期的数据保护。


### 命令解析：

```bash
pg_dump -U $PGUSER -h $PGHOST -F c -b -v -f "/path/to/backup/$db.backup" $db
```

### 选项说明：

1. **`pg_dump`**：  
   这是 PostgreSQL 提供的用于备份数据库的工具。它可以将数据库导出为 SQL 脚本或其他格式的文件，通常用于备份和迁移数据库。

2. **`-U $PGUSER`**：  
   指定连接数据库的用户名。  
   `$PGUSER` 是一个变量，通常是 `postgres` 或者数据库管理员的用户名。你需要用一个具有足够权限的 PostgreSQL 用户来执行备份。

3. **`-h $PGHOST`**：  
   指定数据库服务器的主机名或 IP 地址。  
   `$PGHOST` 是一个变量，表示数据库主机的地址。如果 PostgreSQL 服务运行在本地，可以使用 `localhost`，如果是远程服务器，则使用对应的 IP 地址或域名。

4. **`-F c`**：  
   指定备份文件的格式。  
   `-F` 选项后接备份格式。  
   `c` 表示“自定义格式”（custom format），这是一个压缩格式，适合用于增量备份和使用 `pg_restore` 恢复。它比默认的纯 SQL 格式（`-F p`）更灵活，也能更有效地处理大数据库。

   其他常见的格式选项包括：
    - `p`：纯 SQL 脚本格式。
    - `t`：tar 格式。

5. **`-b`**：  
   包含大对象（Blobs）。  
   这个选项会确保数据库中的大对象（如二进制数据、文件等）也会被包含在备份中。如果数据库没有大对象，这个选项可以省略。

6. **`-v`**：  
   启用详细模式（verbose mode）。  
   这个选项使得 `pg_dump` 在执行时输出更详细的进度信息，便于调试和查看备份过程。

7. **`-f "/path/to/backup/$db.backup"`**：  
   指定备份文件的保存路径。  
   `-f` 后跟的是备份文件的路径和名称。`$db` 是变量，表示当前备份的数据库名称，最终生成的文件名会是数据库名称加上 `.backup` 后缀。例如，如果备份的是名为 `mydb` 的数据库，备份文件会是 `/path/to/backup/mydb.backup`。

8. **`$db`**：  
   最后一个参数是待备份的数据库名称，`$db` 是一个变量，代表当前正在备份的数据库的名称。`pg_dump` 会连接到这个数据库，并将其数据备份到指定的文件中。

### 总结：
这条命令将执行对指定数据库（`$db`）的备份，备份文件将保存在 `/path/to/backup/$db.backup` 路径下，使用自定义格式（`-F c`），包括大对象（`-b`），并输出详细信息（`-v`）。你需要根据自己的环境设置 `$PGUSER`（数据库用户）、`$PGHOST`（数据库主机）和 `$db`（数据库名称）等变量。